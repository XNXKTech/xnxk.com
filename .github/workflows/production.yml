name: Production

on:
  push:
    branches:
      - main
  workflow_dispatch:

jobs:
  build:
    name: Build
    uses: XNXKTech/workflows/.github/workflows/node-build.yml@main
    with:
      runs-on: "['self-hosted']"
      environment: Production
      eslint: true

  depoly:
    name: Kubernetes
    needs:
      - build
    uses: XNXKTech/workflows/.github/workflows/deploy-k8s.yml@main
    with:
      environment: Production
      environment_url: https://www.xnxk.com
    secrets:
      K8S_CONFIG: ${{ secrets.K8S_CONFIG }}
      IAC_TOKEN: ${{ secrets.IAC_TOKEN }}

  cdn:
    runs-on: ubuntu-latest
    needs:
      - deploy

    name: Refresh CDN
    steps:
      - name: Checkout
        uses: actions/checkout@v3.1.0

      - name: Setup Serverless
        uses: teakowa/setup-serverless@v2
        with:
          provider: tencent
        env:
          TENCENT_APPID: ${{ secrets.TENCENTCLOUD_APP_ID }}
          TENCENT_SECRET_ID: ${{ secrets.TENCENTCLOUD_SLS_SECRET_ID }}
          TENCENT_SECRET_KEY: ${{ secrets.TENCENTCLOUD_SLS_SECRET_KEY}}
          SERVERLESS_PLATFORM_VENDOR: tencent

      - name: Refresh CDN
        run: sls deploy

  notification:
    name: Deploy notification
    needs:
      - cdn
    uses: XNXKTech/workflows/.github/workflows/lark-notification.yml@main
    with:
      runs-on: "['self-hosted']"
      stage: Production
    secrets:
      LARK_WEBHOOK_URL: ${{ secrets.SERVICE_UPDATES_ECHO_LARK_BOT_HOOK }}
